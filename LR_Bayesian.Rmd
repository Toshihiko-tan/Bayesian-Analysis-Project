---
title: "LR_Bayesian"
author: "Wang ZiMing"
date: "2024-04-07"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse) # for data manipulation and visualization
library(readr) # for reading data
library(corrplot) # for correlation plots
library(scales) # for data scaling
library(stats) # for logistic regression
library(rstan) # for Bayesian models
library(caret) # for data splitting and pre-processing
library(ggplot2)
```

## Load the dataset
```{r read, echo=FALSE}
df <- read_csv('heart_failure_clinical_records_dataset.csv',show_col_types = FALSE)
head(df)
```

## Death event

```{r}
df$DEATH_EVENT %>% table()
```

```{r}
table(df$smoking)
```

```{r}
na_counts <- sum(is.na(df))
na_counts
```

```{r}
is_binary <- sapply(df, function(x) all(x %in% c(0, 1)))
bin_names <- names(df)[is_binary]
quant_names <- names(df)[!is_binary]
quant_names <- quant_names[quant_names != "time"]

df_binary <- df[bin_names]
# Calculating and plotting the correlation matrix for binary variables
corr_matrix <- cor(df_binary)
corrplot(corr_matrix, method = "circle", type = "upper", order = "hclust", 
         tl.col = "black", tl.srt = 45)

df_quant <- df[quant_names]
# Calculating and plotting the correlation matrix for continuous variables
corr_matrix_cont <- cor(df_quant)
corrplot(corr_matrix_cont, method = "circle", type = "upper", order = "hclust", 
         tl.col = "black", tl.srt = 45)

```

```{r}
y0 <- df[df$DEATH_EVENT == 0,]
y1 <- df[df$DEATH_EVENT == 1,]

# Plot histogram for 'time' where DEATH_EVENT == 0
hist(y0$time, main="Time Distribution for DEATH_EVENT = 0", xlab="Time", col="lightblue")

# Plot histogram for 'time' where DEATH_EVENT == 1
hist(y1$time, main="Time Distribution for DEATH_EVENT = 1", xlab="Time", col="lightgreen")

hist(df$age, main="Age Distribution", xlab="Age", col="lightblue")
death_event_counts <- as.data.frame(table(df$DEATH_EVENT))

ggplot(death_event_counts, aes(x = Var1, y = Freq, fill = Var1)) +
  geom_bar(stat = "identity") +
  labs(x = "Death Event", y = "Count", title = "Distribution of Death Events") +
  scale_fill_manual(values = c("lightblue", "lightgreen"), labels = c("Survived", "Died")) +
  theme_minimal()

```

```{r}
set.seed(451)
y <- df$DEATH_EVENT
X <- df %>% select(-DEATH_EVENT, -time) %>% as.data.frame()
X <- X %>% data.matrix()

model <- glm(y ~ X, family = binomial(link = "logit"))
summary(model)
```

```{r}
stan_model_code <- "
data {
  int<lower=0> N;                   
  int<lower=0, upper=1> y[N];       
  vector[N] age;                      
  vector[N] anaemia;                
  vector[N] creatinine_phosphokinase;
  vector[N] diabetes;                 
  vector[N] ejection_fraction;        
  vector[N] high_blood_pressure;      
  vector[N] platelets;                
  vector[N] serum_creatinine;         
  vector[N] serum_sodium;           
  vector[N] sex;                      
  vector[N] smoking;                  
}
parameters {
  real alpha;                       
  real beta_age;
  real beta_anaemia;
  real beta_cpk;              
  real beta_diabetes;
  real beta_ef;                      
  real beta_hbp;                     
  real beta_platelets;
  real beta_s_creatinine;           
  real beta_s_sodium;                 
  real beta_sex;
  real beta_smoking;
}
model {
  // Priors
  alpha ~ normal(0, 10);
  beta_age ~ normal(0, 10);
  beta_anaemia ~ normal(0, 10);
  beta_cpk ~ normal(0, 10);
  beta_diabetes ~ normal(0, 10);
  beta_ef ~ normal(0, 10);
  beta_hbp ~ normal(0, 10);
  beta_platelets ~ normal(0, 10);
  beta_s_creatinine ~ normal(0, 10);
  beta_s_sodium ~ normal(0, 10);
  beta_sex ~ normal(0, 10);
  beta_smoking ~ normal(0, 10);
  
  // Likelihood
  for (i in 1:N)
    y[i] ~ bernoulli_logit(alpha + beta_age * age[i] + beta_anaemia * anaemia[i] + beta_cpk * creatinine_phosphokinase[i] +
                           beta_diabetes * diabetes[i] + beta_ef * ejection_fraction[i] + beta_hbp * high_blood_pressure[i] +
                           beta_platelets * platelets[i] + beta_s_creatinine * serum_creatinine[i] + beta_s_sodium * serum_sodium[i] +
                           beta_sex * sex[i] + beta_smoking * smoking[i]);
}
"
data_for_stan <- list(
  N = length(y),
  y = as.integer(y),
  age = as.numeric(df$age),
  anaemia = as.numeric(df$anaemia),
  creatinine_phosphokinase = as.numeric(df$creatinine_phosphokinase),
  diabetes = as.numeric(df$diabetes),
  ejection_fraction = as.numeric(df$ejection_fraction),
  high_blood_pressure = as.numeric(df$high_blood_pressure),
  platelets = as.numeric(df$platelets),
  serum_creatinine = as.numeric(df$serum_creatinine),
  serum_sodium = as.numeric(df$serum_sodium),
  sex = as.numeric(df$sex),
  smoking = as.numeric(df$smoking)
)

fit <- stan(model_code = stan_model_code, data = data_for_stan, iter = 5000, chains = 4, warmup = 1000, seed = 101)
print(fit)
```

```{r}
samples <- extract(fit)
continuous_params <- c("alpha", "beta_age", "beta_cpk", "beta_ef", "beta_platelets", 
                       "beta_s_sodium")

for (param in continuous_params) {
  # Get samples for the parameter
  param_samples <- samples[[param]]
  
  # Calculate the 95% CI
  ci <- quantile(param_samples, probs = c(0.025, 0.975))
  cat("95% CI for", param, ":", ci, "\n")

  df <- data.frame(value = param_samples)
  p <- ggplot(df, aes(x = value)) +
    geom_histogram(bins = 30, fill = "lightblue", color = "black") +
    ggtitle(paste("Histogram of posterior", param)) +
    xlab(param) +
    ylab("Frequency") +
    theme_minimal()

  print(p)
}
```

```{r}
categorical_params <- c("beta_anaemia", "beta_diabetes", "beta_hbp",
                        "beta_s_creatinine","beta_sex", "beta_smoking")

for (param in categorical_params) {
  param_samples <- samples[[param]]
  
  # Calculate the 95% CI
  ci <- quantile(param_samples, probs = c(0.025, 0.975))
  cat("95% CI for", param, ":", ci, "\n")
  
  df <- data.frame(value = param_samples)
  p <- ggplot(df, aes(x = value)) +
    geom_histogram(bins = 100, fill = "lightblue", color = "black") +
    ggtitle(paste("Histogram of", param)) +
    xlab(param) +
    ylab("Frequency") +
    theme_minimal()

  print(p)
}
```
